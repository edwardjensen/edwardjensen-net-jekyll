name: Clean up Cloudflare Pages deployments

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'  # Run weekly on Sunday at 3am UTC

jobs:
  cloudflare-cleanup:
    runs-on: ubuntu-latest
    name: Clean up old Cloudflare Pages deployments
    environment: production
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        ref: main

    - name: Clean up old Cloudflare Pages deployments
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
      run: |
        #!/bin/bash
        set -e
        
        echo "=== Cleaning up Cloudflare Pages deployments older than 1 week ==="
        
        # Calculate cutoff date (1 week ago)
        CUTOFF_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)
        echo "Cutoff date: $CUTOFF_DATE"
        
        # Fetch all deployments
        echo "Fetching deployments for project: $CF_PAGES_PROJECT"
        DEPLOYMENTS=$(curl -s -X GET \
          "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$CF_PAGES_PROJECT/deployments" \
          -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
          -H "Content-Type: application/json")
        
        # Check if API call was successful
        if ! echo "$DEPLOYMENTS" | jq -e '.success' > /dev/null; then
          echo "‚ùå Error fetching deployments"
          echo "$DEPLOYMENTS" | jq '.errors'
          exit 1
        fi
        
        echo "Total deployments found: $(echo "$DEPLOYMENTS" | jq '.result | length')"
        
        # Find the most recent production deployment (to protect it)
        LATEST_PROD_ID=$(echo "$DEPLOYMENTS" | jq -r '[.result[] | select(.environment == "production" or (.aliases[0] // "" | contains("edwardjensen.net")))] | sort_by(.created_on) | reverse | .[0].id // "none"')
        
        if [ "$LATEST_PROD_ID" != "none" ]; then
          LATEST_PROD_DATE=$(echo "$DEPLOYMENTS" | jq -r --arg id "$LATEST_PROD_ID" '.result[] | select(.id == $id) | .created_on')
          echo "üîí Protecting most recent production deployment: $LATEST_PROD_ID (created: $LATEST_PROD_DATE)"
        else
          echo "‚ö†Ô∏è  No production deployments found"
        fi
        
        echo ""
        
        # Filter and delete old deployments
        # Use process substitution to avoid subshell issue with counters
        DELETED_COUNT=0
        SKIPPED_COUNT=0
        
        while read -r deployment; do
          DEPLOYMENT_ID=$(echo "$deployment" | jq -r '.id')
          CREATED_ON=$(echo "$deployment" | jq -r '.created_on')
          ENVIRONMENT=$(echo "$deployment" | jq -r '.environment')
          ALIAS=$(echo "$deployment" | jq -r '.aliases[0] // "none"')
          
          # Always protect the most recent production deployment
          if [ "$DEPLOYMENT_ID" = "$LATEST_PROD_ID" ]; then
            echo "üîí Skipping current production deployment: $DEPLOYMENT_ID (created: $CREATED_ON)"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          # Delete all preview builds immediately (regardless of age)
          if [ "$ENVIRONMENT" = "preview" ]; then
            echo "üóëÔ∏è  Deleting preview deployment: $DEPLOYMENT_ID (created: $CREATED_ON)"
            
            DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$CF_PAGES_PROJECT/deployments/$DEPLOYMENT_ID?force=true" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json")
            
            if echo "$DELETE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "‚úÖ Successfully deleted preview deployment: $DEPLOYMENT_ID"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "‚ùå Failed to delete preview deployment: $DEPLOYMENT_ID"
              echo "$DELETE_RESPONSE" | jq '.errors'
            fi
            continue
          fi
          
          # Check if deployment is older than cutoff date
          if [[ "$CREATED_ON" < "$CUTOFF_DATE" ]]; then
            echo "üóëÔ∏è  Deleting old deployment: $DEPLOYMENT_ID (env: $ENVIRONMENT, created: $CREATED_ON)"
            
            DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$CF_PAGES_PROJECT/deployments/$DEPLOYMENT_ID?force=true" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json")
            
            if echo "$DELETE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "‚úÖ Successfully deleted deployment: $DEPLOYMENT_ID"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "‚ùå Failed to delete deployment: $DEPLOYMENT_ID"
              echo "$DELETE_RESPONSE" | jq '.errors'
            fi
          else
            echo "‚è≠Ô∏è  Skipping recent deployment: $DEPLOYMENT_ID (created: $CREATED_ON)"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
          fi
        done < <(echo "$DEPLOYMENTS" | jq -r '.result[] | @json')
        
        echo ""
        echo "=== Cleanup Summary ==="
        echo "Deleted: $DELETED_COUNT deployments"
        echo "Skipped: $SKIPPED_COUNT deployments"
        echo "‚ú® Cleanup complete!"