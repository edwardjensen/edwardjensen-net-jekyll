# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Jekyll-based personal website/portfolio for Edward Jensen, built with Ruby and Jekyll 4.4.1. The site uses Tailwind CSS 4.x for styling and follows an **environment promotion deployment model**. All content (posts, working notes, historic posts) is managed in **Payload CMS** and fetched via GraphQL at build time.

**Content Source**: Payload CMS (`edwardjensencms.com` / `staging.edwardjensencms.com`)  
**Staging**: Self-hosted server (`stagingsite.edwardjensencms.com`)  
**Production**: Cloudflare Pages (`edwardjensen.net`)

## Build Commands

### Local Development
```bash
# Install dependencies
bundle install
npm install

# Serve site locally (development mode)
bundle exec jekyll serve

# Build site (production mode)
JEKYLL_ENV=production bundle exec jekyll build
```

### Accessibility Testing
```bash
# Run accessibility checks (requires site to be running)
npm run a11y              # Check localhost:4000
npm run a11y:dev          # Check development site
npm run a11y:prod         # Check production site
npm run a11y:report       # Generate JSON report
npm run a11y:lenient      # Run without failing on issues
```

## Site Architecture

### Collections Structure

The site uses Jekyll collections defined in [_config.yml](_config.yml):

**CMS-Managed Collections** (content fetched from Payload CMS via GraphQL):
- **`posts`** - Blog posts (permalink: `/posts/YYYY/YYYY-MM/title`)
- **`working_notes`** - Working notes (permalink: `/notes/YYYY-MM-DD/title`)
- **`historic_posts`** - Archived posts (permalink: `/archive/posts/title`)

**File-Based Collections** (content in repository):
- **`_photography/`** - Photography posts (permalink: `/photos/YYYY/YYYY-MM/title`)
- **`_portfolio/`** - Portfolio items (permalink: `/portfolio/title`)
- **`_featured-tags/`** - Featured tag landing pages (permalink: `/tags/title`)
- **`_feeds/`** - JSON Feed configurations (RSS feeds generated by plugin)
- **`_homepage_sections/`** - Homepage section partials (not output)
- **`_landing_sections/`** - Landing page section partials (not output)

### Layouts Hierarchy

The site uses a two-tier layout inheritance pattern (refactored Oct 2025 to full-width stacked layout):

**Base Layouts:**
- **[base.html](_layouts/base.html)** - Root layout with HTML boilerplate, sticky header nav, skip-to-main link, and footer
- **[content-wrapper.html](_layouts/content-wrapper.html)** - Extends base, adds full-width main with max-w-4xl centered container

**Content Layouts** (all extend content-wrapper):
- **[page.html](_layouts/page.html)** - Standard page with header styling
- **[single-post.html](_layouts/single-post.html)** - Blog post with article header, metadata, featured image, navigation
- **[single-working-note.html](_layouts/single-working-note.html)** - Working notes layout
- **[writing-base.html](_layouts/writing-base.html)** - Writing archive pages with customizable header
- **[photography.html](_layouts/photography.html)** - Photography gallery page
- **[portfolio.html](_layouts/portfolio.html)** - Portfolio grid page
- **[landing-page.html](_layouts/landing-page.html)** - Landing pages with custom sections
- **[gallery-page.html](_layouts/gallery-page.html)** - Photo gallery layout
- **[working-notes.html](_layouts/working-notes.html)** - Working notes archive
- **[search-page.html](_layouts/search-page.html)** - Search results page
- **[featured-tag.html](_layouts/featured-tag.html)** - Featured tag landing page with hero image and filtered post list

**Layout Features:**
- Layouts can inject additional `<head>` content via `content_for_head` front matter variable
- Sticky header navigation component included in base layout
- Full-width stacked layout with centered max-w-4xl content container
- Warm amber/slate color scheme throughout

### Includes Structure

Includes are organized into three logical subdirectories in [_includes/](_includes/):

**`core/`** - Infrastructure used by base layouts:

- **[header-includes.html](_includes/core/header-includes.html)** - HTML `<head>` content (meta tags, CSS, fonts, SEO)
- **[footer.html](_includes/core/footer.html)** - Site footer

**`components/`** - Reusable UI elements:

- **[header-nav.html](_includes/components/header-nav.html)** - Sticky header navigation with responsive mobile menu
- **[post-credits.html](_includes/components/post-credits.html)** - Post author attribution box
- **[post-navigation.html](_includes/components/post-navigation.html)** - Previous/next post navigation links
- **[privacy-modal.html](_includes/components/privacy-modal.html)** - Privacy policy modal
- **[working-note.html](_includes/components/working-note.html)** - Working note component
- **[prose-content.html](_includes/components/prose-content.html)** - Formatted prose content wrapper
- **[seo.html](_includes/components/seo.html)** - Custom SEO meta tags (title, description, Open Graph, Twitter Cards)

**`sections/`** - Content sections and list views:

- **[post-list.html](_includes/sections/post-list.html)** - Flexible post listing (supports filtering by year, historical notes)
- **[photos-grid.html](_includes/sections/photos-grid.html)** - Photography gallery grid
- **[portfolio-grid.html](_includes/sections/portfolio-grid.html)** - Portfolio items grid
- **[featured-tags-list.html](_includes/sections/featured-tags-list.html)** - Featured tags index listing with thumbnails and post counts

### Styling Architecture

This project uses Tailwind CSS 4.x with the following configuration:

- **[tailwind.config.js](tailwind.config.js)** - Defines content sources, custom fonts (basic-sans, museo-slab), and includes @tailwindcss/typography plugin
- **[postcss.config.js](postcss.config.js)** - PostCSS processes Tailwind and applies cssnano minification
- **[assets/css/main.css](assets/css/main.css)** - Custom reusable CSS classes in @layer components (buttons, links, text colors, etc.)
- Tailwind is integrated via jekyll-postcss-v2 plugin
- Dark mode is enabled with system-based media query detection

### Data Files

The [_data/](_data/) directory contains:

- **[navbar.yml](_data/navbar.yml)** - Navigation menu structure
- **[social.yml](_data/social.yml)** - Social media links
- **[redirects.yml](_data/redirects.yml)** - URL redirects
- **[a11y-check-urls.yml](_data/a11y-check-urls.yml)** - URLs to check for accessibility
- **[microphotos.json](_data/microphotos.json)** - Processed micro.blog photos (generated by script)
- **[rss-feeds.yml](_data/rss-feeds.yml)** - RSS feed generator configuration
- **[footer-text.yml](_data/footer-text.yml)** - Site disclaimer and feed footer text
- **buildinfo.yml** - Build information (generated during CI/CD)

## Build Scripts

Located in [scripts/](scripts/):

### Micro Photo Processing

- **[microphotojsonprocessor.ps1](scripts/microphotojsonprocessor.ps1)** - Fetches and processes micro.blog photos from `https://micro.edwardjensen.net/photos/index.json`, extracting thumbnails, links, and alt text

```bash
# Fetch and process microphotos (run from root)
npm run photos
# Or directly:
pwsh -File ./scripts/microphotojsonprocessor.ps1 -InputUri "https://micro.edwardjensen.net/photos/index.json"
```

### Accessibility Checking

- **[a11y-check.js](scripts/a11y-check.js)** - Node.js script that runs pa11y accessibility audits on the site using URL definitions from `_data/a11y-check-urls.yml`

```bash
# Run accessibility checks
npm run a11y              # Check localhost:4000
npm run a11y:dev          # Check development site
npm run a11y:staging      # Check staging site
npm run a11y:prod         # Check production site
npm run a11y:report       # Generate JSON report
```

### Asset Management

- **[copy-vendor-assets.js](scripts/copy-vendor-assets.js)** - Copies vendor assets (Alpine.js, Bootstrap Icons) from node_modules to assets directory

## CMS Integration Plugin

The `_plugins/payload_cms.rb` plugin fetches content from Payload CMS via GraphQL at build time.

### Lexical Rich Text Conversion

Payload CMS uses the Lexical editor for rich text content. The plugin converts Lexical JSON to HTML:

- **Paragraphs, headings, lists, blockquotes, code blocks** - Standard HTML conversion
- **Text formatting** - Bold, italic, strikethrough, underline, inline code (uses bitmask: 1=bold, 2=italic, 4=strikethrough, 8=underline, 16=code)
- **Images** - Converted from `upload` nodes with `value.url` and `value.alt`
- **Links** - Handles both internal and external links:
  - **External/Custom links**: `linkType: "custom"` - URL in `node.fields.url`
  - **Internal links**: `linkType: "internal"` - URL in `node.fields.doc.value.permalink`

**Note**: The `markdown` virtual field (server-side Lexical-to-Markdown conversion) is preferred when available. The HTML conversion is a fallback for the `content` field.

## RSS Feed Generator Plugin

The `_plugins/rss_feed_generator.rb` plugin generates all RSS feeds from configuration in `_data/rss-feeds.yml`. It replaces the previous approach of using Liquid templates and a separate featured tag feeds plugin.

### Configuration

Feeds are configured in `_data/rss-feeds.yml`:

```yaml
defaults:
  author: "Edward Jensen"
  language: "en-US"
  xsl_stylesheet: "/assets/css/feed-style.xsl"

feeds:
  - id: main
    title: "Edward Jensen"
    description: "..."
    path: /feed.xml
    collection: posts
    limit: 10
    include_footer: true

dynamic_feeds:
  - id: featured-tags
    source_collection: featured-tags
    title_template: "Edward Jensen - {title}"
    path_template: /feeds/{tag}.xml
    target_collection: posts
    filter_field: tags
    match_field: tag
```

### Feed Types

**Static Feeds** (`feeds[]`):

- `/feed.xml` - Main site feed (all posts)
- `/feeds/essays.xml` - Posts in the "essays" category
- `/feeds/notes.xml` - Working notes (full content)

**Dynamic Feeds** (`dynamic_feeds[]`):

- `/feeds/{tag-slug}.xml` - One feed per featured tag

### JSON Feeds

JSON feeds remain as Liquid templates in `_feeds/`:

- `/feed.json` - Main JSON Feed
- `/feeds/notes.json` - Working Notes JSON Feed

## Pagination Plugin

The `_plugins/pagination_generator.rb` plugin provides collection-agnostic pagination with dynamic filtering support. It replaces `jekyll-paginate-v2` which could not filter posts based on page front matter.

### Pagination Configuration

Pagination defaults and collection-level settings are configured in `_data/pagination.yml`:

```yaml
defaults:
  per_page: 20
  sort_field: date
  sort_reverse: true  # true = newest first

collections:
  featured-tags:
    enabled: true
    collection: posts
    per_page: 10
    filter:
      field: tags
      match: tag  # Matches the 'tag' field in each featured-tag document
```

### Page-Level Configuration

Individual pages can enable pagination via front matter:

```yaml
---
pagination:
  enabled: true
  collection: working_notes
  per_page: 20
---
```

### Filter Options

- **Dynamic filter**: `filter.match` - references a front matter field in the paginating page
- **Static filter**: `filter.value` - uses a fixed value

### Template Usage

Access pagination data via `page.paginator`:

```liquid
{% for item in page.paginator.items %}
  <!-- render item -->
{% endfor %}

{% assign paginator = page.paginator %}
{% include components/pagination.html %}
```

### Paginator Object Properties

| Property | Description |
| -------- | ----------- |
| `items` | Array of items for current page |
| `page` | Current page number (1-indexed) |
| `total_pages` | Total number of pages |
| `total_items` | Total items across all pages |
| `per_page` | Items per page |
| `page_numbers` | Array [1, 2, 3...] for iteration |
| `previous_page` / `previous_page_path` | Previous page navigation |
| `next_page` / `next_page_path` | Next page navigation |
| `first_page_path` / `last_page_path` | First/last page URLs |

### Pagination UI Component

The `_includes/components/pagination.html` component provides a reusable pagination navigation bar with:

- Previous/Next buttons with disabled state
- Page number buttons with ellipsis for large page counts
- Current page highlight (amber-600)
- Accessibility: `aria-current="page"`, proper `role="navigation"`

## Deployment

This project uses **four distinct deployment workflows** to handle different scenarios:

### 1. Production Site (`edwardjensen.net`)
**Workflow**: [deploy-prod-site.yml](.github/workflows/deploy-prod-site.yml)  
**Trigger**: Push `v*` tag  
**Purpose**: Environment promotion from `main` branch on new tag  
**Destination**: Cloudflare Pages  
**CMS Data**: Production CMS  
**Site Code**: Tagged production code (vX.Y.Z)

- Validates tag is on `main` branch before deploying
- Generates build info (commit SHA, run ID, version)
- Processes microphotos from micro.blog
- Builds with `JEKYLL_ENV=production`
- Deploys to Cloudflare Pages using Wrangler
- Creates GitHub Release with auto-generated notes

### 2. Staging Site for Site Code Revisions
**Workflow**: [deploy-staging-site-code.yml](.github/workflows/deploy-staging-site-code.yml)  
**Trigger**: Push to `main` branch  
**Purpose**: Test site code changes before production  
**Destination**: `stagingsite.edwardjensencms.com` (self-hosted server via rsync/SSH)  
**CMS Data**: Production CMS  
**Site Code**: Current `main` branch (may be ahead of latest tag)

- Uses `_config.staging-code.yml` for staging-specific configuration
- Connects to Tailscale VPN for CMS GraphQL access
- Deploys to self-hosted staging server via rsync/SSH

### 3. Staging Site for CMS Changes
**Workflow**: [deploy-staging-cms.yml](.github/workflows/deploy-staging-cms.yml)  
**Trigger**: `repository_dispatch` event type `staging_cms_publish` / manual  
**Purpose**: Test CMS content changes with production site code  
**Destination**: `stagingsite.edwardjensencms.com` (self-hosted server via rsync/SSH)  
**CMS Data**: Staging CMS  
**Site Code**: Latest production tag (vX.Y.Z)

- Checks out latest production tag (not `main` branch)
- Uses `_config.staging-cms.yml` for staging-specific configuration
- Connects to Tailscale VPN for CMS GraphQL access
- Deploys to self-hosted staging server via rsync/SSH

### 4. Republish Production Site
**Workflow**: [republish-prod-site.yml](.github/workflows/republish-prod-site.yml)  
**Trigger**: `repository_dispatch` event type `prod_cms_publish` / manual  
**Purpose**: Rebuild production site with latest CMS content (no code changes)  
**Destination**: Cloudflare Pages  
**CMS Data**: Production CMS  
**Site Code**: Latest production tag (vX.Y.Z)

- Checks out latest production tag (not `main` branch)
- Rebuilds production site with latest CMS content
- Deploys to Cloudflare Pages using Wrangler

### Workflow Summary Table

| Workflow | Trigger | Site Code | CMS Data | Destination |
|----------|---------|-----------|----------|-------------|
| `pr-checks.yml` | Pull request to `main` | PR branch | Production | N/A (build validation only) |
| `deploy-staging-site-code.yml` | Push to `main` | `main` branch | Production | stagingsite.edwardjensencms.com |
| `deploy-staging-cms.yml` | `staging_cms_publish` webhook | Latest `v*` tag | Staging | stagingsite.edwardjensencms.com |
| `deploy-prod-site.yml` | Push `v*` tag | Tagged version | Production | edwardjensen.net |
| `republish-prod-site.yml` | `prod_cms_publish` webhook | Latest `v*` tag | Production | edwardjensen.net |

### Development Workflow

1. **Feature Development**: Create `feature/*` branch from `main`, develop locally
2. **Code Review**: Open PR to merge `feature/*` into `main` (must pass PR checks)
3. **Staging Deployment**: Merge to `main` triggers automatic deployment to staging
4. **Production Promotion**: After validation, create version tag `git tag v1.2.3 && git push --tags`
5. **CMS Changes**: Publish in CMS triggers automatic production rebuild with latest tag

## Environment Variables

Set in GitHub repository variables:
- `RUBY_VERSION` - Ruby version for CI
- `NODE_VERSION` - Node.js version for CI

Set in GitHub secrets:
- `CLOUDFLARE_API_TOKEN`
- `CLOUDFLARE_ACCOUNT_ID`
- `CF_PAGES_PROJECT`

## Image Alt Text Guidelines

From [.github/copilot-instructions.md](.github/copilot-instructions.md):

When writing alt text for images, present it in a fenced code block on a single line for easy copying into Markdown. Include a short description of the image nature first, then all text visible in screenshots exactly as shown. Escape quotation marks and punctuation properly.

## Site Configuration

Key settings in [_config.yml](_config.yml):

- URL: `https://www.edwardjensen.net`
- Uses jekyll-postcss-v2 for Tailwind integration
- Plugins: jekyll-postcss-v2, jekyll-sitemap, jekyll-redirect-from
- Excludes: package files, node_modules, postcss/tailwind configs, .vscode, .github, _config.staging.yml, scripts, .claude, site-docs, CLAUDE.md, README.md
- Kramdown with GFM input for markdown processing
- Permalinks follow pattern: `/:collection/:year/:year-:month/:title`

## Design System Notes

From [.github/copilot-instructions.md](.github/copilot-instructions.md):

### Reusable CSS Classes

The site uses custom Tailwind classes defined in `assets/css/main.css` (@layer components). Always use these for consistency:

- **Text**: `.text-body`, `.text-muted`, `.text-heading`
- **Links**: `.link-accent` (amber links with hover)
- **Buttons**: `.btn-primary`, `.btn-secondary`, `.btn-ghost`
- **Icons**: `.icon-interactive`
- **Components**: `.dropdown-menu`, `.info-box`, `.badge-accent`, `.input-default`, `.section-bg`

### Layout & Color

- **Layout**: Full-width stacked with sticky header (refactored Oct 2025, no sidebar)
- **Header**: Sticky top navigation with backdrop blur, horizontal on desktop, hamburger on mobile
- **Colors**: Warm amber/slate palette (not blue) - amber-600/400 for accents, slate-900/50 for text
- **Typography**: `basic-sans` for body, `museo-slab` for headers, lowercase class for header text
- **Content Container**: max-w-4xl, centered with proper spacing

## Featured Tags Collection

The `_featured-tags/` collection provides curated landing pages for specific tags, displaying a hero image, summary content, and filtered post listings.

**Front Matter Schema:**

```yaml
---
title: "Tag Display Name"           # Required - displayed as page heading
tag: "tag-slug"                     # Required - matches post tags for filtering
image: "https://..."                # Optional - hero image URL
image_alt: "Description..."         # Optional - hero image alt text
sort_ascending: false               # Optional - default false (newest first), true for oldest first
---
```

**Markdown Body:** Rendered as bold summary text above the post list, and used as the RSS feed description.

**Index Page:** Available at `/tags/` ([_site_pages/tags.md](_site_pages/tags.md)) - lists all featured tags with thumbnails, descriptions, and post counts.

**RSS Feeds:** All RSS feeds are generated by the unified `rss_feed_generator.rb` plugin based on configuration in `_config.yml`. Each featured tag gets a feed at `/feeds/{tag-slug}.xml`. The feed description uses the markdown body content from the featured tag file. See the `rss_feeds:` section in `_config.yml` for configuration options.

**Pagination:** Configured via `_data/pagination.yml` collection-level defaults. See the Pagination Plugin section below.

## Documentation Requirements

**IMPORTANT: When making changes to this codebase, you (GitHub Copilot or Claude Code) must update the relevant documentation files as part of your changes.** Documentation should not drift from the actual code.

**Documentation files to update:**

- **`CLAUDE.md`** (this file) - Build commands, site architecture, layouts, includes, deployment
- **`.github/copilot-instructions.md`** - Architecture overview, key patterns, deployment workflow
- **`context-docs/site-work/project-context.md`** - Comprehensive project context and content workflows
- **`context-docs/site-work/content-schema.md`** - Content types and CMS schema documentation

**When to update documentation** (includes but is not limited to):
- New layouts or significant layout changes
- New includes or component patterns
- Changes to the deployment workflow or GitHub Actions
- New collections or content types
- Changes to the CSS class system
- New npm scripts or build commands
- Changes to the GraphQL/CMS integration
- Removing or renaming files referenced in documentation

**Related repository**: The Payload CMS application lives in a separate repository (`edwardjensen/edwardjensencms-payload`). Changes to CMS collections, fields, or content schema should be documented in that repository's `.github/copilot-instructions.md`.
