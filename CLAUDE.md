# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Jekyll-based personal website/portfolio for Edward Jensen, built with Ruby and Jekyll 4.4.1. The site uses Tailwind CSS 4.x for styling and follows an **environment promotion deployment model**. All content (posts, working notes, historic posts) is managed in **Payload CMS** and fetched via GraphQL at build time.

**Content Source**: Payload CMS (`edwardjensencms.com` / `staging.edwardjensencms.com`)  
**Staging**: Self-hosted server (`stagingsite.edwardjensencms.com`)  
**Production**: Cloudflare Pages (`edwardjensen.net`)

## Build Commands

### Local Development
```bash
# Install dependencies
bundle install
npm install

# Serve site locally (development mode)
bundle exec jekyll serve

# Build site (production mode)
JEKYLL_ENV=production bundle exec jekyll build
```

### Accessibility Testing
```bash
# Run accessibility checks (requires site to be running)
npm run a11y              # Check localhost:4000
npm run a11y:dev          # Check development site
npm run a11y:prod         # Check production site
npm run a11y:report       # Generate JSON report
npm run a11y:lenient      # Run without failing on issues
```

## Site Architecture

### Collections Structure

The site uses Jekyll collections defined in [_config.yml](_config.yml):

**CMS-Managed Collections** (content fetched from Payload CMS via GraphQL):
- **`posts`** - Blog posts (permalink: `/posts/YYYY/YYYY-MM/title`)
- **`working_notes`** - Working notes (permalink: `/notes/YYYY-MM-DD/title`)
- **`historic_posts`** - Archived posts (permalink: `/archive/posts/title`)
- **`photography`** - Photography posts (permalink: `/photos/YYYY/YYYY-MM/title`)

**File-Based Collections** (content in repository):

- **`_portfolio/`** - Portfolio items (permalink: `/portfolio/title`)
- **`_featured-tags/`** - Featured tag landing pages (permalink: `/tags/title`)
- **`_feeds/`** - JSON Feed configurations (RSS feeds generated by plugin)
- **`_sections_homepage/`** - Homepage section partials (not output)
- **`_sections_landing/`** - Landing page section partials (not output)
- **`_sections_camerastream/`** - Camera stream page sections (not output)

### Layouts Hierarchy

The site uses a two-tier layout inheritance pattern (refactored Oct 2025 to full-width stacked layout):

**Base Layouts:**
- **[base.html](_layouts/base.html)** - Root layout with HTML boilerplate, sticky header nav, skip-to-main link, and footer
- **[content-wrapper.html](_layouts/content-wrapper.html)** - Extends base, adds full-width main with max-w-7xl centered container

**Content Layouts** (all extend content-wrapper):
- **[page.html](_layouts/page.html)** - Standard page with header styling. Supports `prose: false` front matter to disable prose styling for non-article pages.
- **[single-post.html](_layouts/single-post.html)** - Blog post with article header, metadata, featured image, navigation
- **[single-working-note.html](_layouts/single-working-note.html)** - Working notes layout
- **[single-photo.html](_layouts/single-photo.html)** - Single photography post with photo, EXIF metadata, location map
- **[photography.html](_layouts/photography.html)** - Photography gallery page
- **[portfolio.html](_layouts/portfolio.html)** - Portfolio grid page
- **[landing-page.html](_layouts/landing-page.html)** - Landing pages with custom sections
- **[gallery-page.html](_layouts/gallery-page.html)** - Photo gallery layout
- **[working-notes.html](_layouts/working-notes.html)** - Working notes archive
- **[search-page.html](_layouts/search-page.html)** - Search results page
- **[featured-tag.html](_layouts/featured-tag.html)** - Featured tag landing page with hero image and filtered post list
- **[retired-post.html](_layouts/retired-post.html)** - Archive/retired post layout

**Layout Features:**
- Layouts can inject additional `<head>` content via `content_for_head` front matter variable
- Sticky header navigation component included in base layout
- Full-width stacked layout with centered max-w-7xl content container
- Warm amber/slate color scheme throughout

### Includes Structure

Includes are organized into three logical subdirectories in [_includes/](_includes/):

**`core/`** - Infrastructure used by base layouts:

- **[header-includes.html](_includes/core/header-includes.html)** - HTML `<head>` content (meta tags, CSS, fonts, SEO)
- **[footer.html](_includes/core/footer.html)** - Site footer

**`components/`** - Reusable UI elements:

- **[header-nav.html](_includes/components/header-nav.html)** - Sticky header navigation with responsive mobile menu
- **[page-header.html](_includes/components/page-header.html)** - Reusable page header with icon, title, subtitle
- **[post-credits.html](_includes/components/post-credits.html)** - Post author attribution box
- **[post-navigation.html](_includes/components/post-navigation.html)** - Previous/next post navigation links
- **[photo-metadata.html](_includes/components/photo-metadata.html)** - EXIF metadata display for photography posts
- **[photo-navigation.html](_includes/components/photo-navigation.html)** - Previous/next photo navigation
- **[photo-location-map.html](_includes/components/photo-location-map.html)** - Google Maps embed for photo location
- **[photo-modal.html](_includes/components/photo-modal.html)** - Photo modal overlay (included in base.html, populated by photo-gallery.js)
- **[privacy-modal.html](_includes/components/privacy-modal.html)** - Privacy policy modal
- **[working-note.html](_includes/components/working-note.html)** - Working note component
- **[prose-content.html](_includes/components/prose-content.html)** - Formatted prose content wrapper
- **[seo.html](_includes/components/seo.html)** - Custom SEO meta tags (title, description, Open Graph, Twitter Cards)
- **[pagination.html](_includes/components/pagination.html)** - Pagination navigation UI with page numbers
- **[search-interface.html](_includes/components/search-interface.html)** - Search input with status indicators
- **[search-results.html](_includes/components/search-results.html)** - Search results display with Lunr.js integration

**`sections/`** - Content sections and list views:

- **[post-list.html](_includes/sections/post-list.html)** - Flexible post listing (supports filtering by year, historical notes)
- **[historic-post-list.html](_includes/sections/historic-post-list.html)** - Historic posts collection listing
- **[photos-grid.html](_includes/sections/photos-grid.html)** - Photography gallery grid
- **[portfolio-grid.html](_includes/sections/portfolio-grid.html)** - Portfolio items grid
- **[featured-tags-list.html](_includes/sections/featured-tags-list.html)** - Featured tags index listing with thumbnails and post counts

**`embeds/`** - Embedded content reference templates:

- **[working-note.html](_includes/embeds/working-note.html)** - HTML structure reference for CMS-rendered embedded notes (not included via Liquid)

**Embedded Content System:**

Embedded content (like working notes within blog posts) is rendered as complete HTML by Payload CMS handlers. The HTML is output in the `markdown` field and preserved by kramdown using the `markdown="0"` attribute.

**Important:** Collections that include embedded content must explicitly list the `markdown` field in their GraphQL `fields:` config in `_config.yml`. Without this, embedded content won't be fetched from the CMS.

**CSS for Embeds:**

Embed styles are defined in `assets/css/main.css` using BEM naming convention (`.embedded-{type}`, `.embedded-{type}__element`). The HTML from Payload uses these class names directly.

### Styling Architecture

This project uses Tailwind CSS 4.x with the following configuration:

- **[tailwind.config.js](tailwind.config.js)** - Defines content sources, custom fonts (Fraunces for headers, Source Sans 3 for body), brand color palette, and includes @tailwindcss/typography plugin
- **[postcss.config.js](postcss.config.js)** - PostCSS processes Tailwind and applies cssnano minification
- **[assets/css/main.css](assets/css/main.css)** - Custom reusable CSS classes in @layer components (buttons, links, text colors, etc.)
- Tailwind is integrated via jekyll-postcss-v2 plugin
- Dark mode is enabled with system-based media query detection

### Data Files

The [_data/](_data/) directory contains:

- **[navbar.yml](_data/navbar.yml)** - Navigation menu structure
- **[social.yml](_data/social.yml)** - Social media links
- **[redirects.yml](_data/redirects.yml)** - URL redirects
- **[a11y-check-urls.yml](_data/a11y-check-urls.yml)** - URLs to check for accessibility
- **[rss-feeds.yml](_data/rss-feeds.yml)** - RSS feed generator configuration
- **[pagination.yml](_data/pagination.yml)** - Pagination plugin configuration
- **[sitemap.yml](_data/sitemap.yml)** - Sitemap generator configuration
- **[footer-text.yml](_data/footer-text.yml)** - Site disclaimer and feed footer text
- **[staging-config.yml](_data/staging-config.yml)** - Staging deployment configuration templates
- **[google-maps.yml](_data/google-maps.yml)** - Google Maps Static API settings (zoom, size, proxy URL)
- **[hi-redirects.json](_data/hi-redirects.json)** - Redirect configuration for hi.edwardjensen.net worker
- **buildinfo.yml** - Build information (generated during CI/CD)

## Build Scripts

Located in [scripts/](scripts/):

### Accessibility Checking

- **[a11y-check.js](scripts/a11y-check.js)** - Node.js script that runs pa11y accessibility audits on the site using URL definitions from `_data/a11y-check-urls.yml`

```bash
# Run accessibility checks
npm run a11y              # Check localhost:4000
npm run a11y:dev          # Check development site
npm run a11y:staging      # Check staging site
npm run a11y:prod         # Check production site
npm run a11y:report       # Generate JSON report
```

### Asset Management

- **[copy-vendor-assets.js](scripts/copy-vendor-assets.js)** - Copies vendor assets (Alpine.js, Bootstrap Icons) from node_modules to assets directory

## Cloudflare Workers

All Cloudflare Workers and Pages deployments use **Wrangler v4** (installed via `npm install -g wrangler@4`). GitHub Actions workflows install Wrangler directly rather than using the deprecated `cloudflare/wrangler-action`.

### Google Maps Proxy Worker

Located in `/cloudflare-workers/maps-proxy/`, this Cloudflare Worker proxies requests to Google Maps Static API, keeping the API key server-side for security.

**Files:**

- `worker.js` - Worker logic (validates parameters, forwards to Google Maps API)
- `wrangler.toml` - Cloudflare configuration
- `README.md` - Setup and deployment instructions

**Deployment:**

```bash
cd cloudflare-workers/maps-proxy
wrangler secret put GOOGLE_MAPS_API_KEY
wrangler deploy
```

**Production URL:** `https://ejnetmaps.edwardjensenprojects.com/staticmap`

**Usage:** The site uses `_data/google-maps.yml` to configure the proxy URL, which is used by both the Liquid component (`photo-location-map.html`) and JavaScript modal (`photo-gallery.js`).

**Allowed Parameters:** `center`, `zoom`, `size`, `scale`, `maptype`, `markers`, `format`

### Hi Redirector Worker

Located in `/cloudflare-workers/hi-redirector/`, this Cloudflare Worker handles short URL redirects for `hi.edwardjensen.net` with UTM tracking for analytics.

**Files:**

- `worker.js` - Redirect logic with UTM parameter construction
- `wrangler.toml` - Cloudflare configuration with custom domain
- `README.md` - Setup and deployment instructions

**Configuration:**

Redirect data is stored in `_data/hi-redirects.json`:

```json
{
  "baseUrl": "https://www.edwardjensen.net/hi",
  "social": [{ "platform": "linkedin" }],
  "events": [{ "event": "Event Name", "type": "in-person", "tag": "shorttag" }]
}
```

**Redirect Types:**

- Root `/` - Redirects to main site /hi page
- Social `/linkedin`, `/bluesky`, `/github` - Social platform redirects with UTM params
- Events `/{tag}` - Event-specific redirects with UTM tracking
- `/events.json` - JSON API endpoint listing all events (consumed by main site /hi page)
- Catch-all `/*` - Redirects unknown paths to /hi page

**Deployment:**

Automatically deploys when files in `cloudflare-workers/hi-redirector/` or `_data/hi-redirects.json` are modified on main branch. Manual deploy:

```bash
cd cloudflare-workers/hi-redirector
wrangler deploy
```

**Production URL:** `https://hi.edwardjensen.net`

### Stream Proxy Worker

Located in `/cloudflare-workers/stream-proxy/`, this Cloudflare Worker proxies requests to Cloudflare Stream for the camera stream page.

**Files:**

- `worker.js` - Stream proxy logic
- `wrangler.toml` - Cloudflare configuration
- `README.md` - Setup and deployment instructions

## CMS Integration Plugin

The `_plugins/payload_cms.rb` plugin fetches content from Payload CMS via GraphQL at build time.

### GraphQL Caching Layer

Production builds use a Cloudflare Workers-based caching layer instead of hitting the CMS directly. This provides faster builds and decouples site builds from CMS availability.

**Architecture:**

```text
[Payload CMS] <-- (Tailscale VPN) -- [GitHub Actions: cache refresh]
                                              |
                                              v
                                      [Cloudflare Worker]
                                              |
                                              v
                                      [Cloudflare KV]
                                              |
                                              v
                                      [Jekyll Build]
```

**Key Points:**

- Cache refresh happens in GitHub Actions (which can access Tailscale-protected CMS)
- Jekyll builds read from the Cloudflare cache endpoint
- Each collection is cached separately for granular invalidation
- `prod_cms_publish` webhook refreshes posts, working_notes, historic_posts, pages
- `prod_cms_photo_publish` webhook refreshes photography only

**Configuration:**

```yaml
# _config.yml (production)
graphql_cache:
  enabled: true
  url: https://graphql-cache.edwardjensenprojects.com

# _config.local.yml (bypass cache for local dev)
graphql_cache:
  enabled: false
```

The `GRAPHQL_CACHE_URL` environment variable overrides the config URL.

**Cache Worker Endpoints:**

- `GET /cache/:collection` - Read cached collection data
- `POST /refresh/:collection` - Write collection data (requires API key)
- `GET /status` - Cache metadata for all collections
- `GET /health` - Health check

**Worker Location:** `cloudflare-workers/graphql-cache/`

**Required Secrets:**

- `GRAPHQL_CACHE_API_KEY` - GitHub secret for cache write operations
- `CACHE_API_KEY` - Cloudflare Worker secret (same value)
- `CMS_GRAPHQL_URL` - CMS GraphQL endpoint for cache refresh

### Build Failure on CMS Errors

By default, the build **fails** when:

- CMS endpoint is not configured
- CMS is unreachable (network errors, timeouts)
- CMS returns HTTP errors (4xx/5xx)
- CMS returns zero documents for any configured collection

This ensures CI/CD pipelines surface CMS connectivity issues rather than silently deploying sites with missing content.

To disable this behavior (e.g., for local development without CMS):

```yaml
# _config.local.yml
payload_graphql:
  url: "http://localhost:3000/api/graphql"
  fail_on_error: false  # Allow builds to continue if CMS unavailable
```

### Lexical Rich Text Conversion

Payload CMS uses the Lexical editor for rich text content. The plugin converts Lexical JSON to HTML:

- **Paragraphs, headings, lists, blockquotes, code blocks** - Standard HTML conversion
- **Text formatting** - Bold, italic, strikethrough, underline, inline code (uses bitmask: 1=bold, 2=italic, 4=strikethrough, 8=underline, 16=code)
- **Images** - Converted from `upload` nodes with `value.url` and `value.alt`
- **Links** - Handles both internal and external links:
  - **External/Custom links**: `linkType: "custom"` - URL in `node.fields.url`
  - **Internal links**: `linkType: "internal"` - URL in `node.fields.doc.value.permalink`

**Note**: The `markdown` virtual field (server-side Lexical-to-Markdown conversion) is preferred when available. The HTML conversion is a fallback for the `content` field.

## RSS Feed Generator Plugin

The `_plugins/rss_feed_generator.rb` plugin generates all RSS feeds from configuration in `_data/rss-feeds.yml`. It replaces the previous approach of using Liquid templates and a separate featured tag feeds plugin.

### Configuration

Feeds are configured in `_data/rss-feeds.yml`:

```yaml
defaults:
  author: "Edward Jensen"
  language: "en-US"
  xsl_stylesheet: "/assets/css/feed-style.xsl"

feeds:
  - id: main
    title: "Edward Jensen"
    description: "..."
    path: /feed.xml
    collection: posts
    limit: 10
    include_footer: true

dynamic_feeds:
  - id: featured-tags
    source_collection: featured-tags
    title_template: "Edward Jensen - {title}"
    path_template: /feeds/{tag}.xml
    target_collection: posts
    filter_field: tags
    match_field: tag
```

### Feed Types

**Static Feeds** (`feeds[]`):

- `/feed.xml` - Main site feed (all posts)
- `/feeds/essays.xml` - Posts in the "essays" category
- `/feeds/notes.xml` - Working notes (full content)

**Dynamic Feeds** (`dynamic_feeds[]`):

- `/feeds/{tag-slug}.xml` - One feed per featured tag

### JSON Feeds

JSON feeds remain as Liquid templates in `_feeds/`:

- `/feed.json` - Main JSON Feed
- `/feeds/notes.json` - Working Notes JSON Feed

## Pagination Plugin

The `_plugins/pagination_generator.rb` plugin provides collection-agnostic pagination with dynamic filtering support. It replaces `jekyll-paginate-v2` which could not filter posts based on page front matter.

### Pagination Configuration

Pagination defaults and collection-level settings are configured in `_data/pagination.yml`:

```yaml
defaults:
  per_page: 20
  sort_field: date
  sort_reverse: true  # true = newest first

collections:
  featured-tags:
    enabled: true
    collection: posts
    per_page: 10
    filter:
      field: tags
      match: tag  # Matches the 'tag' field in each featured-tag document
```

### Page-Level Configuration

Individual pages can enable pagination via front matter:

```yaml
---
pagination:
  enabled: true
  collection: working_notes
  per_page: 20
---
```

### Filter Options

- **Dynamic filter**: `filter.match` - references a front matter field in the paginating page
- **Static filter**: `filter.value` - uses a fixed value

### Template Usage

Access pagination data via `page.paginator`:

```liquid
{% for item in page.paginator.items %}
  <!-- render item -->
{% endfor %}

{% assign paginator = page.paginator %}
{% include components/pagination.html %}
```

### Paginator Object Properties

| Property | Description |
| -------- | ----------- |
| `items` | Array of items for current page |
| `page` | Current page number (1-indexed) |
| `total_pages` | Total number of pages |
| `total_items` | Total items across all pages |
| `per_page` | Items per page |
| `page_numbers` | Array [1, 2, 3...] for iteration |
| `previous_page` / `previous_page_path` | Previous page navigation |
| `next_page` / `next_page_path` | Next page navigation |
| `first_page_path` / `last_page_path` | First/last page URLs |

### Pagination UI Component

The `_includes/components/pagination.html` component provides a reusable pagination navigation bar with:

- Previous/Next buttons with disabled state
- Page number buttons with ellipsis for large page counts
- Current page highlight (brand-orange)
- Accessibility: `aria-current="page"`, proper `role="navigation"`

### CMS Integration Note

**Future consideration**: When content types are managed in the CMS, pagination configuration should be handled via collection-level config in `_data/pagination.yml` rather than front matter, since CMS-sourced content may not support arbitrary front matter fields. The current implementation already supports this pattern for `featured-tags`. If a CMS collection needs pagination, add its config to the `collections:` section of `_data/pagination.yml`.

## Sitemap Generator Plugin

The `_plugins/sitemap_generator.rb` plugin generates a sitemaps.org-compliant `sitemap.xml` file. It replaces the abandoned `jekyll-sitemap` gem (last updated 2019).

### Configuration

Sitemap settings are configured in `_data/sitemap.yml`:

```yaml
output_path: /sitemap.xml

# Patterns to exclude (glob matching)
exclude_patterns:
  - "/feeds/*.json"   # Exclude JSON feed files
```

### Entry Inclusion/Exclusion

The plugin includes:
- All `site.pages` with URLs
- All documents from collections with `output: true`

The plugin excludes:
- Entries with `sitemap: false` in front matter
- Entries with `searchable: false` in front matter (unless `sitemap: true` is also set)
- Entries matching `exclude_patterns` (glob matching)
- Pagination pages (URLs containing `/page/`)
- Draft/unpublished CMS content (`_status == 'draft'`)
- Non-HTML files (CSS, JS, JSON, XML, images, fonts)
- Special files (404.html, _redirects, robots.txt)

**Override behavior**: An explicit `sitemap: true` overrides the `searchable: false` exclusion, allowing a page to appear in the sitemap while remaining excluded from site search.

### Date Handling

The `<lastmod>` element uses dates in this priority order:
1. `updatedAt` - CMS updated timestamp (most accurate)
2. `date` - Publication date
3. `site.time` - Build time (fallback)

### robots.txt

The `robots.txt` file in the project root references the sitemap URL using Liquid templating:

```
Sitemap: {{ "sitemap.xml" | absolute_url }}
```

## Deployment

This project uses **six deployment workflows** with a unified staging architecture:

### Workflow Overview

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `pr-checks.yml` | Pull request to `main` | Build validation (no deployment) |
| `deploy-staging.yml` | Push to `main`, repository_dispatch, manual | Unified staging deployment |
| `deploy-prod-site.yml` | Push `v*` tag | Production release |
| `republish-prod.yml` | `prod_cms_publish` or `prod_cms_photo_publish` webhook, manual | Rebuild production with CMS changes |
| `deploy-hi-redirector.yml` | Push to `main` (worker files), manual | Deploy hi.edwardjensen.net worker |
| `cleanup-cloudflare.yml` | Weekly schedule, manual | Clean old Cloudflare deployments |

### Unified Staging Workflow

The `deploy-staging.yml` workflow uses configuration from `_data/staging-config.yml` to handle multiple staging scenarios with two configuration dimensions:

**Configuration Dimensions:**

- **site_code**: `main` (current branch) or `latest-tag` (production vX.Y.Z tag)
- **cms_source**: `production` or `staging` CMS
- **deploy_target**: `local-server` (stagingsite.edwardjensencms.com) or `cloudflare` (staging.edwardjensen.net)

**Trigger Mappings:**

| Trigger | site_code | cms_source | deploy_target |
|---------|-----------|------------|---------------|
| Push to `main` | main | staging | cloudflare |
| `staging_cms_publish` | latest-tag | staging | local-server |
| `staging_cms_photo_publish` | main | staging | local-server |
| Manual (default) | main | production | local-server |

**Site Titles by Configuration:**

- `main` + `production` = "Edward Jensen [CODE STAGING]"
- `main` + `staging` = "Edward Jensen [STAGING CMS + CODE]"
- `latest-tag` + `production` = "Edward Jensen [TAG STAGING]"
- `latest-tag` + `staging` = "Edward Jensen [CMS STAGING]"

### Production Workflows

**1. `deploy-prod-site.yml`** (Production Release)

- **Trigger**: Push `v*` tag
- **Site Code**: Tagged version
- **CMS Data**: Production
- **Destination**: Cloudflare Pages (edwardjensen.net)
- Creates GitHub Release with auto-generated notes

**2. `republish-prod.yml`** (CMS Content Refresh)

- **Trigger**: `prod_cms_publish` or `prod_cms_photo_publish` webhook, or manual
- **Site Code**: Latest `v*` tag
- **CMS Data**: Production
- **Destination**: Cloudflare Pages
- Handles both general content and photography publishing in a single consolidated workflow

### Maintenance Workflows

**`cleanup-cloudflare.yml`** - Runs weekly (Sunday 3am UTC) to delete:

- All preview deployments (immediately)
- Production deployments older than 7 days (except the most recent)

### Workflow Summary Table

| Workflow | Trigger | Site Code | CMS Data | Destination |
|----------|---------|-----------|----------|-------------|
| `pr-checks.yml` | Pull request to `main` | PR branch | Production | N/A (build only) |
| `deploy-staging.yml` | Push to `main` | `main` branch | Staging | staging.edwardjensen.net |
| `deploy-staging.yml` | `staging_cms_publish` | Latest `v*` tag | Staging | stagingsite.edwardjensencms.com |
| `deploy-prod-site.yml` | Push `v*` tag | Tagged version | Production | edwardjensen.net |
| `republish-prod.yml` | `prod_cms_publish` or `prod_cms_photo_publish` | Latest `v*` tag | Production | edwardjensen.net |

### Development Workflow

1. **Feature Development**: Create `feature/*` branch from `main`, develop locally
2. **Code Review**: Open PR to merge `feature/*` into `main` (must pass PR checks)
3. **Staging Deployment**: Merge to `main` triggers automatic deployment to staging
4. **Production Promotion**: After validation, create version tag `git tag v1.2.3 && git push --tags`
5. **CMS Changes**: Publish in CMS triggers automatic production rebuild with latest tag

## Environment Variables

Set in GitHub repository variables:
- `RUBY_VERSION` - Ruby version for CI
- `NODE_VERSION` - Node.js version for CI

Set in GitHub secrets:
- `CLOUDFLARE_API_TOKEN` - API token with required permissions (see below)
- `CLOUDFLARE_ACCOUNT_ID` - Cloudflare account ID
- `CF_PAGES_PROJECT` - Cloudflare Pages project name

### Cloudflare API Token Permissions

The `CLOUDFLARE_API_TOKEN` must have the following permissions:

| Permission | Access | Used By |
|------------|--------|---------|
| Account → Cloudflare Pages | Edit | All Pages deployments |
| Account → Workers Scripts | Edit | Worker deployments (hi-redirector, maps-proxy) |
| Zone → Workers Routes | Edit | Custom domain routing for workers |

To create or update the token:
1. Go to https://dash.cloudflare.com/profile/api-tokens
2. Create a token with the permissions above, or use the "Edit Cloudflare Workers" template and add Pages permissions

## Image Alt Text Guidelines

From [.github/copilot-instructions.md](.github/copilot-instructions.md):

When writing alt text for images, present it in a fenced code block on a single line for easy copying into Markdown. Include a short description of the image nature first, then all text visible in screenshots exactly as shown. Escape quotation marks and punctuation properly.

## Site Configuration

Key settings in [_config.yml](_config.yml):

- URL: `https://www.edwardjensen.net`
- Uses jekyll-postcss-v2 for Tailwind integration
- Plugins: jekyll-postcss-v2, jekyll-sitemap, jekyll-redirect-from
- Excludes: package files, node_modules, postcss/tailwind configs, .vscode, .github, _config.staging.yml, scripts, .claude, site-docs, CLAUDE.md, README.md
- Kramdown with GFM input for markdown processing
- Permalinks follow pattern: `/:collection/:year/:year-:month/:title`

## Design System Notes

From [.github/copilot-instructions.md](.github/copilot-instructions.md):

### Reusable CSS Classes

The site uses custom Tailwind classes defined in `assets/css/main.css` (@layer components). Always use these for consistency:

- **Text**: `.text-body`, `.text-muted` (accessible grey variants), `.text-heading`
- **Links**: `.link-accent` (accessible orange-dark with chestnut hover)
- **Buttons**: `.btn-primary`, `.btn-secondary`, `.btn-ghost`
- **Icons**: `.icon-interactive`
- **Components**: `.dropdown-menu`, `.info-box`, `.badge-accent`, `.input-default`, `.section-bg`

### Layout & Color

- **Layout**: Full-width stacked with sticky header (refactored Oct 2025, no sidebar)
- **Header**: Sticky top navigation with backdrop blur, horizontal on desktop, hamburger on mobile
- **Colors**: Brand palette (2026) with accessible variants:
  - `brand-ink` (#001524) / `brand-smoke` (#F3F3F3) - backgrounds and text
  - `brand-chestnut` (#772E25) - default link color (7.5:1 contrast ✅)
  - `brand-orange` (#F58F29) - decorative accents only (fails contrast for text)
  - `brand-orange-dark` (#a95b00) - accessible orange text (4.5:1 ✅)
  - `brand-grey-dark` (#5A5E6D) - muted text on light backgrounds (5.5:1 ✅)
  - `brand-grey-light` (#9499AB) - muted text on dark backgrounds (5.8:1 ✅)
  - `brand-grey` (#767B91) - borders/decorative only (fails contrast for text)
- **Typography**: `Source Sans 3` for body (400/600 weights only), `Fraunces` for headers (600/700), lowercase class for header text. **Always use `font-semibold` for bold text, never `font-bold` or `font-medium`.**
- **Font Loading**: Fonts loaded via `@import` at top of `assets/css/main.css` with optimized Google Fonts API call
- **Content Container**: max-w-7xl, centered with proper spacing

## Photography Collection

The `photography` collection is managed in Payload CMS and fetched via GraphQL at build time. Each photo post includes optional EXIF metadata and location information.

**Key Fields (from CMS):**

- `title` - Photo title
- `date` - Publication date
- `image` / `image_alt` - Photo URL and accessibility text
- `tags` - Tag slugs for categorization
- `exif_*` fields - Camera, lens, focal length, aperture, shutter speed, ISO
- `location_lat` / `location_lng` / `location_name` - Geolocation data

**Detailed Schema:** See `context-docs/site-work/photography.md` for full documentation.

### Gallery Modal with URL Routing

The photography gallery uses a modal overlay system with browser history integration.

**Key Files:**

- **[photography.html](_layouts/photography.html)** - Gallery layout with embedded JSON data store containing all photos
- **[photo-gallery.js](assets/js/photo-gallery.js)** - Alpine.js component with History API (pushState/popState)
- **[photo-page-modal.js](assets/js/photo-page-modal.js)** - Transforms single photo pages to gallery + modal view
- **[photo-modal.html](_includes/components/photo-modal.html)** - Modal HTML template (included in base.html)
- **[single-photo.html](_layouts/single-photo.html)** - SEO/no-JS fallback, loads photo-page-modal.js
- **[photos-grid.html](_includes/sections/photos-grid.html)** - Grid with `@click.prevent="openPhotoByUrl()"` handlers

**User Experience:**

1. Gallery grid at `/photos/` shows paginated thumbnails
2. Click photo → modal opens over gallery, URL changes to `/photos/2025/2025-12/photo-title`
3. Modal shows: image (left), details panel (right on desktop, below on mobile)
4. Back button → closes modal, returns to source URL (context-aware)
5. Direct URL → fetches gallery page, displays modal over it

**Key Features:**

- **Source URL Tracking**: The `sourceUrl` property tracks where the user came from (homepage, gallery, featured tag page) for context-aware back navigation with appropriate labels ("Home", "Gallery", or "Back")
- **XSS Prevention**: The `escapeHtml()` function sanitizes dynamic content in modal titles to prevent cross-site scripting
- **Google Maps Configuration**: Map settings centralized in `_data/google-maps.yml` (zoom, size, scale, proxy URL)

**Two Operating Modes:**

- **Full Mode** (photography index): JSON data store present, URL routing enabled, full modal with EXIF/map
- **Simple Mode** (homepage): Data attributes on buttons, lightbox-only, no URL changes

## Featured Tags Collection

The `_featured-tags/` collection provides curated landing pages for specific tags, displaying a hero image, summary content, and filtered post listings.

**Front Matter Schema:**

```yaml
---
title: "Tag Display Name"           # Required - displayed as page heading
tag: "tag-slug"                     # Required - matches post tags for filtering
image: "https://..."                # Optional - hero image URL
image_alt: "Description..."         # Optional - hero image alt text
sort_ascending: false               # Optional - default false (newest first), true for oldest first
---
```

**Markdown Body:** Rendered as bold summary text above the post list, and used as the RSS feed description.

**Index Page:** Available at `/tags/` ([_site_pages/tags.md](_site_pages/tags.md)) - lists all featured tags with thumbnails, descriptions, and post counts.

**RSS Feeds:** All RSS feeds are generated by the unified `rss_feed_generator.rb` plugin based on configuration in `_data/rss-feeds.yml`. Each featured tag gets a feed at `/feeds/{tag-slug}.xml`. The feed description uses the markdown body content from the featured tag file.

**Pagination:** Configured via `_data/pagination.yml` collection-level defaults. See the Pagination Plugin section below.

## Camera Stream Page

The site includes an occasionally live camera stream page featuring a Cloudflare Stream embed of downtown Saint Paul, Minnesota.

**Page Location:** [_site_pages/saintpaullive.md](_site_pages/saintpaullive.md)
**URL:** `/saintpaulcamera/`
**Layout:** `landing-page`
**Sections Collection:** `_sections_camerastream/`

**Key Files:**

- **[saintpaullive.md](_site_pages/saintpaullive.md)** - Page definition with front matter
- **[livestream.html](_sections_camerastream/livestream.html)** - Cloudflare Stream iframe embed

**Stream Configuration:**

The livestream section uses a Cloudflare Stream iframe with autoplay enabled:

```html
<iframe
  src="https://customer-xxx.cloudflarestream.com/xxx/iframe?autoplay=true&muted=true"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  allowfullscreen
></iframe>
```

**Notes:**

- Autoplay requires `muted=true` due to browser autoplay policies
- The stream automatically plays when live content is available
- Uses `aspect-video` for 16:9 responsive sizing
- The page is excluded from site search (`searchable: false`) but included in sitemap

## Documentation Requirements

**CRITICAL: When making changes to this codebase, you (GitHub Copilot or Claude Code) MUST update the relevant documentation files as part of your changes.** Documentation drift causes significant problems for AI-assisted development.

### Primary Documentation Files (MUST be kept in sync)

These two files are the primary references for AI assistants and MUST BOTH be updated when making code changes:

| File | Purpose | AI Consumer |
|------|---------|-------------|
| **`CLAUDE.md`** | Comprehensive guide, detailed architecture | Claude Code |
| **`.github/copilot-instructions.md`** | Quick reference, key patterns, deployment | GitHub Copilot |

**Both files document the same codebase from different perspectives.** Changes to one typically require changes to the other. When in doubt, update both.

### Secondary Documentation Files

- **`context-docs/site-work/project-context.md`** - Deep technical context and content workflows
- **`context-docs/site-work/content-schema.md`** - CMS field documentation and content types

### When to Update Documentation

Update documentation for ANY of the following:

- New layouts or significant layout changes
- New includes or component patterns
- Changes to the deployment workflow or GitHub Actions
- New collections or content types
- Changes to the CSS class system
- New npm scripts or build commands
- Changes to the GraphQL/CMS integration
- Removing or renaming files referenced in documentation
- New data files in `_data/`
- New plugins in `_plugins/`

### Cross-Repository Documentation

The Payload CMS application lives in a separate repository (`edwardjensen/edwardjensencms-payload`). Changes to CMS collections, fields, or content schema should be documented in that repository's `.github/copilot-instructions.md`.
